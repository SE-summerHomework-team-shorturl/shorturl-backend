version: "3.8"
services:
  mysql:
    image: mysql:latest
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - 3306:3306
    environment:
      MYSQL_ROOT_PASSWORD: root
    command: --default-authentication-plugin=mysql_native_password
  redis:
    build: ./redis
    volumes:
      - redis-data:/data
    ports:
      - 6379:6379
  rabbitmq:
    image: rabbitmq:management
    ports:
      - 5672:5672
      - 15672:15672
  consul:
    image: consul:latest
    ports:
      - 8500:8500
      - 8600:8600/udp
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
  prometheus:
    build: ./prometheus
    ports:
      - 9090:9090
    depends_on:
      - consul
  grafana:
    image: grafana/grafana:latest
    ports:
      - 3000:3000
  config-server:
    build: ./config-server
    depends_on:
      - consul
  gateway:
    build: ./gateway
    ports:
      - 8080:8080
    depends_on:
      - consul
      - config-server
  register-service:
    build: ./register-service
    depends_on:
      - mysql
      - consul
      - config-server
  auth-server:
    build: ./auth-server
    depends_on:
      - mysql
      - consul
      - config-server
  addurl-service:
    build: ./addurl-service
    depends_on:
      - mysql
      - redis
      - consul
      - config-server
      - gateway
      - auth-server
  statistic-service:
    build: ./statistic-service
    depends_on:
      - mysql
      - rabbitmq
      - consul
      - config-server
  redirect-service:
    build: ./redirect-service
    depends_on:
      - mysql
      - redis
      - consul
      - config-server
  userurl-service:
    build: ./userurl-service
    depends_on:
      - mysql
      - redis
      - consul
      - config-server
      - gateway
      - auth-server
  admin-service:
    build: ./admin-service
    depends_on:
      - mysql
      - redis
      - consul
      - config-server
      - gateway
      - auth-server
volumes:
  mysql-data:
  redis-data:
